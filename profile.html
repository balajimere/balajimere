<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Profile â€“ Shree Balaji Oil Agency</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{--green:#03A64A}
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:var(--green);color:#fff;padding:14px;text-align:center;font-size:20px;font-weight:bold}
.card{background:#fff;margin:15px;padding:20px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.15)}
.profile-img{width:120px;height:120px;border-radius:50%;object-fit:cover;display:block;margin:0 auto 10px;border:3px solid var(--green)}
.row{margin-top:10px;font-size:15px}
.label{color:#777;font-size:13px}
.value{font-weight:bold;color:#333}
button{width:100%;padding:12px;margin-top:15px;border:none;border-radius:8px;background:var(--green);color:#fff;font-size:15px;cursor:pointer}
.logout{background:#F21D44}

.list{background:#fff;margin:15px;padding:10px;border-radius:10px}

/* INSTAGRAM STYLE GRID */
#myPosts{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:5px;
 margin:10px;
}
.post-card{
 background:#fff;
 border-radius:6px;
 overflow:hidden;
 position:relative;
}
.post-card img{
 width:100%;
 height:120px;
 object-fit:cover;
}
.post-actions{
 position:absolute;
 bottom:0;
 left:0;
 right:0;
 background:rgba(0,0,0,.6);
 display:flex;
 justify-content:space-around;
}
.post-actions button{
 background:none;
 border:none;
 color:#fff;
 font-size:12px;
 padding:6px;
}
</style>
</head>

<body>

<header>My Profile</header>

<div class="card">
 <img id="photo" class="profile-img" src="https://via.placeholder.com/120">

 <div class="row"><div class="label">Name</div><div class="value" id="name"></div></div>
 <div class="row"><div class="label">Mobile</div><div class="value" id="mobile"></div></div>
 <div class="row"><div class="label">Shop Name</div><div class="value" id="shop"></div></div>
 <div class="row"><div class="label">Address</div><div class="value" id="address"></div></div>

 <button onclick="location.href='login.html'">Edit Profile</button>
 <button class="logout" onclick="logout()">Logout</button>
</div>

<!-- FOLLOW LIST -->
<div class="list">
 <h3>Following</h3>
 <div id="followingList"></div>
</div>

<div class="list">
 <h3>Followers</h3>
 <div id="followersList"></div>
</div>

<!-- MY POSTS -->
<div id="myPosts"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
  authDomain: "balajimere-c8eb9.firebaseapp.com",
  projectId: "balajimere-c8eb9"
});
const db=firebase.firestore();

let user = localStorage.getItem("user");
if(!user){ location.href="login.html"; }

let d = JSON.parse(user);

/* PROFILE DATA */
document.getElementById("name").innerText = d.name || "";
document.getElementById("mobile").innerText = d.mobile || "";
document.getElementById("shop").innerText = d.shop || "";
document.getElementById("address").innerText = d.address || "";
if(d.photo){ document.getElementById("photo").src=d.photo }

function logout(){
 localStorage.removeItem("user");
 location.href="login.html";
}

/* MY POSTS */
db.collection("posts").where("uid","==",d.mobile).orderBy("time","desc")
.onSnapshot(s=>{
 myPosts.innerHTML="";
 s.forEach(doc=>{
  let p=doc.data();
  myPosts.innerHTML+=`
   <div class="post-card">
    <img src="${p.img}">
    <div class="post-actions">
     <button onclick="editPost('${doc.id}','${p.desc||""}')">Edit</button>
     <button onclick="deletePost('${doc.id}')">Delete</button>
    </div>
   </div>`;
 });
});

/* EDIT POST */
function editPost(id,old){
 let t=prompt("Edit post",old);
 if(t!=null){
  db.collection("posts").doc(id).update({desc:t});
 }
}

/* DELETE POST */
function deletePost(id){
 if(confirm("Delete this post?")){
  db.collection("posts").doc(id).delete();
 }
}

/* FOLLOWING LIST (SHOW ONLY NAME) */
db.collection("users").doc(d.mobile).onSnapshot(u=>{
 let f=u.data().following||[];
 followingList.innerHTML="";
 f.forEach(uid=>{
  db.collection("users").doc(uid).get().then(doc=>{
   if(doc.exists){
    let uname = doc.data().name || "User";
    followingList.innerHTML+=`
     <div>${uname} <button onclick="unfollow('${uid}')">Unfollow</button></div>
    `;
   }
  });
 });
});

/* FOLLOWERS LIST (SHOW ONLY NAME) */
db.collection("users").onSnapshot(s=>{
 followersList.innerHTML="";
 s.forEach(doc=>{
  let u=doc.data();
  if((u.following||[]).includes(d.mobile)){
   followersList.innerHTML+=`<div>${u.name||"User"}</div>`;
  }
 });
});

/* UNFOLLOW */
function unfollow(uid){
 db.collection("users").doc(d.mobile).update({
  following: firebase.firestore.FieldValue.arrayRemove(uid)
 });
}
</script>

</body>
</html>
