<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#03A64A;color:#fff;padding:12px;text-align:center;font-size:20px}
.controls{background:#fff;padding:10px}
select,button,input{padding:6px;margin:4px}
.order{background:#fff;margin:10px;padding:12px;border-radius:10px}
.btn{padding:6px 10px;border:none;border-radius:5px;font-size:13px;cursor:pointer;margin:2px}
.approve{background:#03A64A;color:#fff}
.reject{background:#e74c3c;color:#fff}
.dispatch{background:#f39c12;color:#fff}
.delivered{background:#2980b9;color:#fff}
.pdf{background:#555;color:#fff}
.small{font-size:13px;color:#555}
.report{background:#fff;margin:10px;padding:10px;border-radius:10px}
</style>
</head>

<body>

<script>
const ADMIN_EMAIL = "balajimere.admin@gmail.com";
const ADMIN_PASSWORD = "Balaji@631625";

if(localStorage.getItem("adminAuth")!=="yes"){
 let email = prompt("Enter Admin Email");
 let pass  = prompt("Enter Admin Password");
 if(email!==ADMIN_EMAIL || pass!==ADMIN_PASSWORD){
  alert("Access Denied");
  location.reload();
 }else{
  localStorage.setItem("adminAuth","yes");
 }
}
</script>

<header>Admin Order Panel</header>

<div class="controls">
 Filter:
 <select id="filter" onchange="render()">
  <option>All</option>
  <option>Pending</option>
  <option>Done</option>
  <option>Dispatch</option>
  <option>Delivered</option>
  <option>Rejected</option>
 </select>

 <button onclick="exportExcel()">ðŸ“Š Export Excel</button><br><br>

 ðŸ“… From <input type="date" id="fromDate">
 To <input type="date" id="toDate">
 <button onclick="dateReport()">ðŸ“ˆ Sales Report</button>
</div>

<div class="report" id="reportBox"></div>
<div id="orders"></div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});

const db=firebase.firestore();
let all=[];

db.collection("orders").orderBy("time","desc").onSnapshot(s=>{
 all=[];
 s.forEach(d=>all.push({id:d.id,...d.data()}));
 render();
});

function render(){
 let f=filter.value;
 orders.innerHTML="";
 all.forEach(o=>{
  if(f!="All" && o.status!=f) return;

  let inv=o.invoice||("INV-"+o.id.slice(-6).toUpperCase());
  let items="";
  o.products.forEach(p=>{
   items+=`${p.name} Ã— ${p.qty} = â‚¹${p.price*p.qty}<br>`;
  });

  orders.innerHTML+=`
  <div class="order">
   <b>${o.user.name}</b> (${o.user.mobile})<br>
   <span class="small">${o.user.shop}<br>${o.user.address}</span><br><br>

   ${items}
   <b>Total: â‚¹${o.total}</b><br>
   Invoice: <b>${inv}</b><br>
   Status: <b>${o.status}</b><br><br>

   ${buttons(o,inv)}
   <button class="btn pdf" onclick='pdf("${inv}",${JSON.stringify(o)})'>PDF</button>
  </div>`;
 });
}

function buttons(o,inv){
 if(o.status=="Pending")
 return `
 <button class="btn approve" onclick="update('${o.id}','Done','Approved',${o.total},'${inv}','${o.user.mobile}')">Approve</button>
 <button class="btn reject" onclick="update('${o.id}','Rejected')">Reject</button>`;
 return "";
}

async function update(id,status,msg,amt,inv,mobile){
 await db.collection("orders").doc(id).update({status,invoice:inv});
 window.open(`https://wa.me/91${mobile}?text=`+
 encodeURIComponent(`Order ${msg}\nInvoice: ${inv}\nAmount: â‚¹${amt}`));
}

function exportExcel(){
 let ws=XLSX.utils.json_to_sheet(all.map(o=>({
  Invoice:o.invoice,Name:o.user.name,Total:o.total,Status:o.status
 })));
 let wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Orders");
 XLSX.writeFile(wb,"Orders.xlsx");
}

/* ===== PDF + WHATSAPP ===== */
function pdf(invoice, order){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();

 let y=15;
 doc.setFontSize(16);
 doc.text("Shree Balaji Oil Agency",105,y,{align:"center"});
 y+=10;

 doc.setFontSize(10);
 doc.text(`Invoice: ${invoice}`,10,y); y+=6;
 doc.text(`Name: ${order.user.name}`,10,y); y+=6;
 doc.text(`Mobile: ${order.user.mobile}`,10,y); y+=6;
 doc.text(`Shop: ${order.user.shop}`,10,y); y+=6;
 doc.text(`Address: ${order.user.address}`,10,y); y+=8;

 order.products.forEach(p=>{
  doc.text(`${p.name} x ${p.qty} = â‚¹${p.price*p.qty}`,10,y);
  y+=6;
 });

 y+=6;
 doc.text(`Total: â‚¹${order.total}`,10,y);

 doc.save(invoice+".pdf");

 let msg=`Shree Balaji Oil Agency
Invoice: ${invoice}
Name: ${order.user.name}
Mobile: ${order.user.mobile}

${order.products.map(p=>p.name+" x "+p.qty).join("\n")}
Total â‚¹${order.total}`;

 window.open("https://wa.me/91"+order.user.mobile+"?text="+encodeURIComponent(msg));
}
</script>

</body>
</html>
