<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#03A64A;color:#fff;padding:12px;text-align:center;font-size:20px}
.controls{padding:10px;background:#fff}
select{padding:6px}
.order{background:#fff;margin:10px;padding:12px;border-radius:10px}
.btn{padding:6px 10px;border:none;border-radius:5px;font-size:13px;cursor:pointer}
.approve{background:#03A64A;color:#fff}
.reject{background:#e74c3c;color:#fff}
.pdf{background:#555;color:#fff}
.done{color:green;font-weight:bold}
.rejected{color:red;font-weight:bold}
.small{font-size:13px;color:#555}
.report{background:#fff;margin:10px;padding:10px;border-radius:10px}
</style>
</head>

<body>

<header>Admin Order Panel</header>

<div class="controls">
 Filter:
 <select id="filter" onchange="renderOrders()">
  <option value="All">All</option>
  <option value="Pending">Pending</option>
  <option value="Done">Done</option>
  <option value="Rejected">Rejected</option>
 </select>
</div>

<div class="report" id="report"></div>
<div id="orders"></div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});
const db=firebase.firestore();
const ADMIN_WA="8959216904";
const GST=0.05;

let allOrders=[];

/* ðŸ”” ADMIN WHATSAPP ALERT ON NEW ORDER */
db.collection("orders").where("adminSeen","==",false)
.onSnapshot(snap=>{
 snap.forEach(d=>{
  let o=d.data();
  window.open(
   `https://wa.me/91${ADMIN_WA}?text=${encodeURIComponent(
    `ðŸ›’ NEW ORDER\n${o.user.name}\nâ‚¹${o.total}`
   )}`,"_blank"
  );
  db.collection("orders").doc(d.id).update({adminSeen:true});
 });
});

/* LOAD ORDERS */
db.collection("orders").orderBy("time","desc")
.onSnapshot(snap=>{
 allOrders=[];
 snap.forEach(d=>allOrders.push({id:d.id,...d.data()}));
 renderOrders();
});

/* RENDER */
function renderOrders(){
 let f=document.getElementById("filter").value;
 let box=document.getElementById("orders");
 let todayTotal=0;
 box.innerHTML="";

 allOrders.forEach(o=>{
  if(f!="All" && o.status!=f) return;

  let gst=Math.round(o.total*GST);
  let grand=o.total+gst;
  let invoice=o.invoice || "INV-"+o.id.slice(-6).toUpperCase();

  if(o.status=="Done"){
   let d=o.time.toDate();
   let t=new Date();
   if(d.toDateString()==t.toDateString())
    todayTotal+=grand;
  }

  let items="";
  o.products.forEach(p=>{
   items+=`${p.name} x ${p.qty} = â‚¹${p.price*p.qty}\n`;
  });

  box.innerHTML+=`
  <div class="order">
   <b>${o.user.name}</b> (${o.user.mobile})<br>
   <span class="small">${o.user.shop}</span><br><br>

   <pre class="small">${items}</pre>

   Invoice: <b>${invoice}</b><br>
   Total: â‚¹${o.total}<br>
   GST: â‚¹${gst}<br>
   <b>Grand: â‚¹${grand}</b><br><br>

   ${
    o.status=="Pending"
    ? `
     <button class="btn approve" onclick="approve('${o.id}','${o.user.mobile}','${invoice}',${grand})">Approve</button>
     <button class="btn reject" onclick="rejectOrder('${o.id}')">Reject</button>
    `
    : o.status=="Done"
      ? `<span class="done">âœ” Approved</span>`
      : `<span class="rejected">âœ– Rejected</span>`
   }
   <button class="btn pdf" onclick='pdf("${invoice}","${o.user.name}",\`${items}\`,${o.total},${gst},${grand})'>PDF</button>
  </div>`;
 });

 document.getElementById("report").innerHTML=
  `<b>Today Sales:</b> â‚¹${todayTotal}`;
}

/* APPROVE */
async function approve(id,mobile,invoice,amt){
 await db.collection("orders").doc(id).update({
  status:"Done",
  invoice:invoice
 });
 window.open(
  `https://wa.me/91${mobile}?text=${encodeURIComponent(
   `âœ… ORDER APPROVED\nInvoice: ${invoice}\nAmount: â‚¹${amt}`
  )}`,"_blank"
 );
}

/* REJECT */
function rejectOrder(id){
 if(confirm("Reject this order?")){
  db.collection("orders").doc(id).update({status:"Rejected"});
 }
}

/* PDF */
function pdf(inv,name,items,total,gst,grand){
 const {jsPDF}=window.jspdf;
 let p=new jsPDF();
 p.text("INVOICE",80,10);
 p.text(`Invoice: ${inv}`,10,20);
 p.text(`Customer: ${name}`,10,30);
 p.text("Items:",10,40);
 p.text(items,10,50);
 p.text(`Total: â‚¹${total}`,10,120);
 p.text(`GST: â‚¹${gst}`,10,130);
 p.text(`Grand Total: â‚¹${grand}`,10,140);
 p.save(inv+".pdf");
}
</script>

</body>
</html>
