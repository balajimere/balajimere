<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#03A64A;color:#fff;padding:12px;text-align:center;font-size:20px}
.controls{padding:10px;background:#fff}
select{padding:6px}
.order{background:#fff;margin:10px;padding:12px;border-radius:10px}
.btn{padding:6px 10px;border:none;border-radius:5px;font-size:13px;cursor:pointer;margin:2px}
.approve{background:#03A64A;color:#fff}
.reject{background:#e74c3c;color:#fff}
.pdf{background:#555;color:#fff}
.wa{background:#25D366;color:#fff}
.done{color:green;font-weight:bold}
.rejected{color:red;font-weight:bold}
.small{font-size:13px;color:#555}
.report{background:#fff;margin:10px;padding:10px;border-radius:10px}
textarea{width:100%;padding:6px}
</style>
</head>

<body>

<header>Admin Order Panel</header>

<div class="controls">
 Filter:
 <select id="filter" onchange="renderOrders()">
  <option value="All">All</option>
  <option value="Pending">Pending</option>
  <option value="Done">Done</option>
  <option value="Rejected">Rejected</option>
 </select>
 GST:
 <select id="gstToggle" onchange="renderOrders()">
  <option value="on">With GST</option>
  <option value="off">Without GST</option>
 </select>
</div>

<div class="report" id="report"></div>
<div id="orders"></div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});
const db=firebase.firestore();
const GST_RATE=0.05;
let allOrders=[];

/* LOAD ORDERS */
db.collection("orders").orderBy("time","desc")
.onSnapshot(snap=>{
 allOrders=[];
 snap.forEach(d=>allOrders.push({id:d.id,...d.data()}));
 renderOrders();
});

function renderOrders(){
 let f=filter.value;
 let gstOn=gstToggle.value=="on";
 let box=orders;
 let monthTotal=0;
 box.innerHTML="";

 allOrders.forEach(o=>{
  if(f!="All" && o.status!=f) return;

  let gst=gstOn?Math.round(o.total*GST_RATE):0;
  let grand=o.total+gst;
  let inv=o.invoice||"INV-"+o.id.slice(-6).toUpperCase();
  let d=o.time?.toDate?.()||new Date();

  if(d.getMonth()==new Date().getMonth() && o.status=="Done"){
    monthTotal+=grand;
  }

  let items="";
  o.products.forEach(p=>{
   items+=`${p.name} Ã— ${p.qty} = â‚¹${p.price*p.qty}\n`;
  });

  box.innerHTML+=`
  <div class="order">
   <b>${o.user.name}</b> (${o.user.mobile})<br>
   <span class="small">${o.user.shop}<br>${o.user.address}</span><br><br>

   <pre class="small">${items}</pre>

   Invoice: <b>${inv}</b><br>
   Total: â‚¹${o.total}<br>
   GST: â‚¹${gst}<br>
   <b>Grand: â‚¹${grand}</b><br><br>

   ${o.status=="Pending"?
    `<button class="btn approve" onclick="approve('${o.id}','${o.user.mobile}','${inv}',${grand})">Approve</button>
     <button class="btn reject" onclick="rejectOrder('${o.id}')">Reject</button>`
    : o.status=="Done"?`<span class="done">âœ” Approved</span>`:`<span class="rejected">âœ– Rejected</span>`}

   <button class="btn pdf" onclick='pdf("${inv}",${JSON.stringify(o)},${gst},${grand})'>PDF</button>

   <button class="btn wa" onclick="wa('${o.user.mobile}','â³ Payment Pending\\nInvoice: ${inv}\\nAmount: â‚¹${grand}')">Pending Payment</button>

   <button class="btn wa" onclick="wa('${o.user.mobile}','ðŸ” Repeat Order\\nInvoice: ${inv}')">Repeat Order</button>

   <textarea id="msg${o.id}" placeholder="Custom message"></textarea>
   <button class="btn wa" onclick="wa('${o.user.mobile}',document.getElementById('msg${o.id}').value)">Send Msg</button>
  </div>`;
 });

 report.innerHTML=`<b>Monthly Sales:</b> â‚¹${monthTotal}`;
}

function wa(m,msg){
 if(!msg) return alert("Message empty");
 window.open(`https://wa.me/91${m}?text=`+encodeURIComponent(msg));
}

async function approve(id,mobile,inv,amt){
 await db.collection("orders").doc(id).update({status:"Done",invoice:inv});
 wa(mobile,`âœ… Order Approved\nInvoice: ${inv}\nAmount: â‚¹${amt}`);
}

function rejectOrder(id){
 if(confirm("Reject order?")){
  db.collection("orders").doc(id).update({status:"Rejected"});
 }
}

function pdf(inv,o,gst,grand){
 const {jsPDF}=window.jspdf;
 let p=new jsPDF();
 let y=10;
 p.text("INVOICE",80,y); y+=10;
 p.text(`Invoice: ${inv}`,10,y); y+=8;
 p.text(`Name: ${o.user.name}`,10,y); y+=8;
 p.text(`Mobile: ${o.user.mobile}`,10,y); y+=8;
 p.text(`Shop: ${o.user.shop}`,10,y); y+=8;
 p.text(`Address: ${o.user.address}`,10,y); y+=10;

 o.products.forEach(pr=>{
  p.text(`${pr.name} Ã— ${pr.qty} = â‚¹${pr.price*pr.qty}`,10,y);
  y+=8;
 });

 y+=5;
 p.text(`Total: â‚¹${o.total}`,10,y); y+=8;
 p.text(`GST: â‚¹${gst}`,10,y); y+=8;
 p.text(`Grand Total: â‚¹${grand}`,10,y);

 p.save(inv+".pdf");
}
</script>

</body>
</html>
