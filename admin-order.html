<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#03A64A;color:#fff;padding:12px;text-align:center;font-size:20px}
.controls{background:#fff;padding:10px}
select,button,input,textarea{padding:6px;margin:4px;width:auto}
textarea{width:98%}
.order{background:#fff;margin:10px;padding:12px;border-radius:10px}
.btn{padding:6px 10px;border:none;border-radius:5px;font-size:13px;cursor:pointer;margin:2px}
.approve{background:#03A64A;color:#fff}
.reject{background:#e74c3c;color:#fff}
.dispatch{background:#f39c12;color:#fff}
.delivered{background:#2980b9;color:#fff}
.pdf{background:#555;color:#fff}
.wa{background:#25D366;color:#fff}
.small{font-size:13px;color:#555}
.report{background:#fff;margin:10px;padding:10px;border-radius:10px}
</style>
</head>

<body>

<script>
/* ğŸ” ADMIN LOGIN */
const ADMIN_EMAIL="balajimere.admin@gmail.com";
const ADMIN_PASSWORD="Balaji@631625";
if(localStorage.getItem("adminAuth")!=="yes"){
 let e=prompt("Admin Email");
 let p=prompt("Admin Password");
 if(e!==ADMIN_EMAIL || p!==ADMIN_PASSWORD){
  alert("Access Denied");
  location.reload();
 }else localStorage.setItem("adminAuth","yes");
}
</script>

<header>Admin Order Panel</header>

<div class="controls">
 Filter:
 <select id="filter" onchange="render()">
  <option>All</option>
  <option>Pending</option>
  <option>Done</option>
  <option>Dispatch</option>
  <option>Delivered</option>
  <option>Rejected</option>
 </select>

 <button onclick="exportExcel()">ğŸ“Š Export Excel</button>

 <br><br>
 ğŸ“… From <input type="date" id="fromDate">
 To <input type="date" id="toDate">
 <button onclick="dateReport()">ğŸ“ˆ Sales</button>

 <br><br>
 ğŸ“² <b>Global WhatsApp Message</b><br>
 <textarea id="globalMsg" placeholder="Type one message here â€“ this will go to all users"></textarea>
</div>

<div class="report" id="reportBox"></div>
<div id="orders"></div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});
const db=firebase.firestore();
let all=[];

/* LOAD ORDERS */
db.collection("orders").orderBy("time","desc")
.onSnapshot(s=>{
 all=[];
 s.forEach(d=>all.push({id:d.id,...d.data()}));
 render();
});

function render(){
 let f=filter.value;
 orders.innerHTML="";
 all.forEach(o=>{
  if(f!="All" && o.status!=f) return;

  let inv=o.invoice||("INV-"+o.id.slice(-6).toUpperCase());
  let itemsTxt="",itemsHtml="";
  o.products.forEach(p=>{
   itemsTxt+=`${p.name} x ${p.qty} = â‚¹${p.price*p.qty}\n`;
   itemsHtml+=`${p.name} Ã— ${p.qty} = â‚¹${p.price*p.qty}<br>`;
  });

  orders.innerHTML+=`
  <div class="order">
   <b>${o.user.name}</b> (${o.user.mobile})<br>
   <span class="small">${o.user.shop}<br>${o.user.address}</span><br><br>

   ${itemsHtml}
   <b>Total: â‚¹${o.total}</b><br>
   Invoice: <b>${inv}</b><br>
   Status: <b>${o.status}</b><br><br>

   ğŸ“¦ Courier:
   <input placeholder="Courier Name" id="cname-${o.id}" value="${o.courierName||""}">
   <input placeholder="Courier Phone" id="cphone-${o.id}" value="${o.courierPhone||""}">
   <input placeholder="Tracking No" id="track-${o.id}" value="${o.tracking||""}">
   <button onclick="saveCourier('${o.id}')">ğŸ’¾ Save</button>
   <br><br>

   ${buttons(o,inv)}

   <button class="btn pdf" onclick='pdf("${inv}",${JSON.stringify(o)})'>ğŸ“„ PDF</button>

   <button class="btn wa" onclick="sendWA('${o.user.mobile}','${inv}',\`${itemsTxt}\`,${o.total})">
    ğŸ“² Send WhatsApp
   </button>
  </div>`;
 });
}

/* STATUS BUTTONS */
function buttons(o,inv){
 if(o.status=="Pending")
 return `
 <button class="btn approve" onclick="update('${o.id}','Done','Approved',${o.total},'${inv}','${o.user.mobile}')">Approve</button>
 <button class="btn reject" onclick="update('${o.id}','Rejected')">Reject</button>`;
 if(o.status=="Done")
 return `<button class="btn dispatch" onclick="dispatch('${o.id}','${o.user.mobile}','${inv}',${o.total})">Dispatch</button>`;
 if(o.status=="Dispatch")
 return `<button class="btn delivered" onclick="update('${o.id}','Delivered','Delivered',${o.total},'${inv}','${o.user.mobile}')">Delivered</button>`;
 return "";
}

/* SAVE COURIER */
async function saveCourier(id){
 await db.collection("orders").doc(id).update({
  courierName:cname-${id}.value,
  courierPhone:cphone-${id}.value,
  tracking:track-${id}.value
 });
 alert("Saved");
}

/* WHATSAPP ORDER SEND */
function sendWA(mobile,inv,items,total){
 let msg=document.getElementById("globalMsg").value;
 if(!msg) return alert("Type global message");
 let text=`${msg}\n\nInvoice: ${inv}\n${items}\nTotal: â‚¹${total}`;
 window.open(`https://wa.me/91${mobile}?text=`+encodeURIComponent(text));
}

/* PDF FIXED (NO BUG) */
function pdf(inv,o){
 const {jsPDF}=window.jspdf;
 let p=new jsPDF();
 let y=20;

 p.setFontSize(16);
 p.text("SHREE BALAJI OIL AGENCY",40,15);
 p.setFontSize(10);
 p.text("Ujjain (M.P.)",40,21);

 y=35;
 p.text("Invoice: "+inv,10,y); y+=7;
 p.text("Name: "+o.user.name,10,y); y+=7;
 p.text("Mobile: "+o.user.mobile,10,y); y+=7;
 p.text("Address: "+o.user.address,10,y); y+=10;

 o.products.forEach(pr=>{
  p.text(`${pr.name} x ${pr.qty} = â‚¹${pr.price*pr.qty}`,10,y);
  y+=7;
 });

 y+=5;
 p.text("Total Amount: â‚¹"+o.total,10,y);

 p.save(inv+".pdf");
}

/* REPORT */
function dateReport(){
 let f=new Date(fromDate.value);
 let t=new Date(toDate.value);
 let sum=0;
 all.forEach(o=>{
  let d=o.time?.toDate?.();
  if(d>=f && d<=t && (o.status=="Done"||o.status=="Delivered")) sum+=o.total;
 });
 reportBox.innerHTML=`<b>Sales:</b> â‚¹${sum}`;
}

/* EXCEL */
function exportExcel(){
 let ws=XLSX.utils.json_to_sheet(all.map(o=>({
  Invoice:o.invoice,Name:o.user.name,Total:o.total,Status:o.status
 })));
 let wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Orders");
 XLSX.writeFile(wb,"Orders.xlsx");
}
</script>

</body>
</html>
