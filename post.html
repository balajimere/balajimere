<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Post</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#03A64A;color:#fff;padding:14px;text-align:center;font-size:20px}

.story-bar{display:flex;overflow-x:auto;background:#fff;padding:8px;position:relative}
.story{text-align:center;margin-right:10px}
.story img{width:60px;height:60px;border-radius:50%;border:3px solid green}

.card{background:#fff;margin:10px;border-radius:10px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}

.post-img{width:100%;border-radius:10px;margin-top:8px}

.actions{display:flex;justify-content:space-around;margin-top:10px;font-size:20px}
.actions i{cursor:pointer}

.comment{display:flex;align-items:center;margin-top:5px}
.comment img{width:30px;height:30px;border-radius:50%;margin-right:6px}

.comment-box input{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-top:6px}

/* POST MODAL */
#postBox,#storyBox{
 position:fixed;
 bottom:-100%;
 left:0;
 width:100%;
 background:#fff;
 padding:10px;
 box-shadow:0 -2px 10px rgba(0,0,0,.3);
 transition:.3s;
}
#postBox.show,#storyBox.show{bottom:0}

/* FLOAT BUTTON */
#addBtn,#storyBtn{
 position:fixed;
 background:#03A64A;
 color:#fff;
 width:55px;
 height:55px;
 border-radius:50%;
 font-size:26px;
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
}
#addBtn{bottom:15px;right:15px}

/* STORY BUTTON SHIFTED UP */
#storyBtn{top:70px;right:15px}
</style>
</head>

<body>

<header>Social Post</header>

<div class="story-bar" id="storyBar"></div>

<div id="postList"></div>

<!-- POST FORM -->
<div id="postBox">
 <input type="file" id="photo">
 <textarea id="desc" placeholder="Write description..."></textarea>
 <button onclick="uploadPost()">Post</button>
 <button onclick="closePost()">Cancel</button>
</div>

<!-- STORY FORM -->
<div id="storyBox">
 <input type="file" id="storyImg">
 <button onclick="uploadStory()">Add Story</button>
 <button onclick="closeStory()">Cancel</button>
</div>

<div id="addBtn" onclick="openPost()">+</div>
<div id="storyBtn" onclick="openStory()">ðŸ“¸</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
  authDomain: "balajimere-c8eb9.firebaseapp.com",
  projectId: "balajimere-c8eb9"
});
const db=firebase.firestore();
const IMGBB_KEY="5e77bfe737324a6c147697a13fefcb3d";

/* LOGIN CHECK */
let user = JSON.parse(localStorage.getItem("user"));
if(!user){ location.href="login.html"; }

function openPost(){postBox.classList.add("show")}
function closePost(){postBox.classList.remove("show")}
function openStory(){storyBox.classList.add("show")}
function closeStory(){storyBox.classList.remove("show")}

/* FOLLOW USER */
function followUser(uid){
 db.collection("users").doc(user.mobile).update({
  following: firebase.firestore.FieldValue.arrayUnion(uid)
 });
 alert("Followed");
}

/* UPLOAD STORY */
async function uploadStory(){
 let f=document.getElementById("storyImg").files[0];
 if(!f) return alert("Select story image");

 let fd=new FormData();
 fd.append("image",f);
 let r=await fetch("https://api.imgbb.com/1/upload?key="+IMGBB_KEY,{method:"POST",body:fd});
 let j=await r.json();

 await db.collection("stories").add({
  uid:user.mobile,
  name:user.name,
  photo:user.photo,
  image:j.data.url,
  time:new Date()
 });
 closeStory();
}

/* LOAD STORIES */
db.collection("users").doc(user.mobile).onSnapshot(u=>{
 let following=u.data().following||[];

 db.collection("stories").onSnapshot(s=>{
  storyBar.innerHTML="";
  let now=Date.now();

  s.forEach(d=>{
   let st=d.data();
   let t=st.time.toDate().getTime();

   if(now-t>86400000){ db.collection("stories").doc(d.id).delete(); return;}

   if(st.uid==user.mobile || following.includes(st.uid)){
    storyBar.innerHTML+=`
     <div class="story">
      <img src="${st.image}" onclick="window.open('${st.image}')">
      <div>${st.name}</div>
     </div>`;
   }
  });
 });
});

/* UPLOAD POST */
async function uploadPost(){
 let file=document.getElementById("photo").files[0];
 if(!file) return alert("Select photo");

 let fd=new FormData();
 fd.append("image",file);
 let res=await fetch("https://api.imgbb.com/1/upload?key="+IMGBB_KEY,{method:"POST",body:fd});
 let json=await res.json();

 await db.collection("posts").add({
  uid:user.mobile,
  img:json.data.url,
  desc:desc.value,
  name:user.name,
  photo:user.photo,
  likes:[],
  time:new Date()
 });
 desc.value=""; photo.value=""; closePost();
}

/* LOAD POSTS */
db.collection("posts").orderBy("time","desc").onSnapshot(snap=>{
 postList.innerHTML="";
 snap.forEach(d=>{
  let p=d.data();
  let likes=p.likes||[];
  let liked=likes.includes(user.mobile);

  postList.innerHTML+=`
  <div class="card">
   <div class="comment">
    <img src="${p.photo}">
    <b>${p.name}</b>
    ${p.uid!=user.mobile?`<button onclick="followUser('${p.uid}')">Follow</button>`:
    `<button onclick="editPost('${d.id}','${p.desc||""}')">Edit</button>
     <button onclick="deletePost('${d.id}')">Delete</button>`}
   </div>

   <img src="${p.img}" class="post-img">
   <p>${p.desc||""}</p>

   <div class="actions">
    <i class="fa-solid fa-heart" style="color:${liked?'red':'black'}"
     onclick="likePost('${d.id}',${JSON.stringify(likes)})"></i>
    <i class="fa-solid fa-comment"></i>
    <i class="fa-solid fa-share" onclick="sharePost('${p.img}')"></i>
   </div>

   <div id="cmt${d.id}"></div>

   <div class="comment-box">
    <input id="ci${d.id}" placeholder="Write comment & Enter"
      onkeydown="if(event.key==='Enter') addComment('${d.id}')">
   </div>
  </div>`;
  loadComments(d.id);
 });
});

/* EDIT POST */
function editPost(id,oldText){
 let newText=prompt("Edit your post",oldText);
 if(newText!=null){
  db.collection("posts").doc(id).update({desc:newText});
 }
}

/* DELETE POST */
function deletePost(id){
 if(confirm("Delete this post?")){
  db.collection("posts").doc(id).delete();
 }
}

/* LIKE */
function likePost(id,likes){
 if(likes.includes(user.mobile)){
  likes=likes.filter(l=>l!==user.mobile);
 }else{likes.push(user.mobile);}
 db.collection("posts").doc(id).update({likes});
}

/* COMMENTS */
function addComment(id){
 let i=document.getElementById("ci"+id);
 let txt=i.value.trim(); if(!txt)return;
 db.collection("posts").doc(id).collection("comments").add({
  uid:user.mobile,text:txt,name:user.name,photo:user.photo,time:new Date()
 });
 i.value="";
}
function loadComments(id){
 db.collection("posts").doc(id).collection("comments").orderBy("time").onSnapshot(s=>{
  let box=document.getElementById("cmt"+id); box.innerHTML="";
  s.forEach(d=>{
   let c=d.data();
   box.innerHTML+=`<div class="comment"><img src="${c.photo}"><b>${c.name}</b>: ${c.text}</div>`;
  });
 });
}

/* SHARE */
function sharePost(img){
 window.open("https://wa.me/?text="+encodeURIComponent(img));
}
</script>
</body>
 </html>
