<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{--green:#03A64A}
body{margin:0;font-family:Arial;background:#f7f7f7}

header{
 background:var(--green);
 color:#fff;
 text-align:center;
 padding:14px;
 font-size:20px;
 font-weight:bold
}

.box{padding:12px;margin-bottom:160px}

.section{
 background:#fff;
 border-radius:10px;
 padding:10px;
 margin-bottom:10px;
 box-shadow:0 2px 5px rgba(0,0,0,.1)
}

.item{display:flex;justify-content:space-between;font-size:14px}

.total{font-size:18px;font-weight:bold;text-align:right}

textarea{width:100%;padding:8px;border-radius:6px}

.place{
 position:fixed;bottom:0;left:0;width:100%;
 background:#fff;border-top:1px solid #ddd;padding:12px
}

.place button{
 width:100%;padding:12px;font-size:16px;
 background:#25D366;color:#fff;border:none;
 border-radius:6px;cursor:pointer
}

.history{font-size:14px}
.badge{padding:3px 8px;border-radius:4px;color:#fff;font-size:12px}
.pending{background:orange}
.done{background:green}
</style>
</head>

<body>

<header>Confirm Order</header>

<div class="box">

 <div class="section" id="userBox"></div>

 <div class="section">
  <h3>Products</h3>
  <div id="items"></div>
  <div class="total">Total â‚¹<span id="total">0</span></div>
 </div>

 <div class="section">
  <h3>Note</h3>
  <textarea id="note"></textarea>
 </div>

 <div class="section">
  <h3>Order History</h3>
  <div id="history" class="history"></div>
 </div>

</div>

<div class="place">
 <button onclick="placeOrder()">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="22" style="vertical-align:middle">
  Order to WhatsApp
 </button>
</div>

<script>
/* USER */
let user=JSON.parse(localStorage.getItem("user"));
if(!user)location.href="login.html";

/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});
const db=firebase.firestore();

const ADMIN_WHATSAPP="918959216904";
const USER_WHATSAPP="91"+user.mobile;

/* USER BOX */
userBox.innerHTML=`
<b>${user.name}</b><br>${user.shop}<br>${user.mobile}<br>${user.address}
`;

/* CART */
let cart=JSON.parse(localStorage.getItem("cart")||"[]");
let total=0;
cart.forEach(p=>{
 total+=p.price*p.qty;
 items.innerHTML+=`<div class="item"><span>${p.name} Ã— ${p.qty}</span><span>â‚¹${p.price*p.qty}</span></div>`;
});
document.getElementById("total").innerText=total;

/* ORDER */
async function placeOrder(){
 let order={
  user,products:cart,total,
  note:note.value,status:"Pending",
  time:new Date()
 };

 let ref=await db.collection("orders").add(order);

 sendAdmin(order,ref.id);
 sendUser(ref.id);

 localStorage.removeItem("cart");
 alert("Order sent to WhatsApp");
 location.href="home.html";
}

/* ADMIN WHATSAPP + PDF */
function sendAdmin(order,id){
 let msg=`ðŸ§¾ ORDER #${id}\n${order.user.name}\n${order.user.mobile}\n\nTotal â‚¹${order.total}`;
 window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=`+encodeURIComponent(msg));
 generatePDF(order,id);
}

/* USER CONFIRM */
function sendUser(id){
 let msg=`âœ… Order Confirmed\nOrder ID: ${id}\nTotal â‚¹${total}`;
 window.open(`https://wa.me/${USER_WHATSAPP}?text=`+encodeURIComponent(msg));
}

/* PDF */
function generatePDF(order,id){
 let w=window.open("");
 w.document.write(`<h2>Order Invoice</h2>
 <b>ID:</b>${id}<br>
 <b>Name:</b>${order.user.name}<br>
 <b>Total:</b>â‚¹${order.total}<hr>`);
 order.products.forEach(p=>{
  w.document.write(`${p.name} Ã— ${p.qty}<br>`);
 });
 w.print();
}

/* ORDER HISTORY */
db.collection("orders")
.where("user.mobile","==",user.mobile)
.onSnapshot(s=>{
 history.innerHTML="";
 s.forEach(d=>{
  let o=d.data();
  history.innerHTML+=`
   <div>
    #${d.id} - â‚¹${o.total}
    <span class="badge ${o.status=="Pending"?"pending":"done"}">${o.status}</span>
   </div>`;
 });
});
</script>

</body>
</html>
