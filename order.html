<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{--green:#03A64A}
body{margin:0;font-family:Arial;background:#f7f7f7}
header{background:var(--green);color:#fff;text-align:center;padding:14px;font-size:20px;font-weight:bold}
.box{padding:12px;margin-bottom:220px}
.section{background:#fff;border-radius:10px;padding:10px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.item{display:flex;justify-content:space-between;font-size:14px}
.total{font-size:18px;font-weight:bold;text-align:right}
textarea,input{width:100%;padding:8px;border-radius:6px;margin:4px 0}
.place{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:1px solid #ddd;padding:10px}
.place button{width:100%;padding:12px;font-size:16px;background:#25D366;color:#fff;border:none;border-radius:6px;cursor:pointer;margin-bottom:8px}
.pdfbtn{background:#333!important}
.history{font-size:14px}
.badge{padding:3px 8px;border-radius:4px;color:#fff;font-size:12px}
.pending{background:orange}
.done{background:green}
.dispatch{background:#f39c12}
.delivered{background:#2980b9}
.rejected{background:red}
</style>
</head>

<body>

<header>Confirm Order</header>

<div class="box">

<div class="section" id="userBox"></div>

<div class="section">
<h3>üõí Products</h3>
<div id="items"></div>
<div class="total">Total ‚Çπ<span id="total">0</span></div>
</div>

<div class="section">
<h3>üìù Note</h3>
<textarea id="note"></textarea>
</div>

<div class="section">
<h3>üì¶ My Orders</h3>
<div id="history" class="history"></div>
</div>

</div>

<div class="place">
<button onclick="placeOrder()">
<img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="20">
 Order to WhatsApp
</button>

<button class="pdfbtn" onclick="generateLastPDF()">Generate PDF</button>
</div>

<script>
/* üî• FIREBASE CONFIG */
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});
const db=firebase.firestore();
const ADMIN_WHATSAPP="918959216904";

/* üë§ USER */
let user=JSON.parse(localStorage.getItem("user"));
if(!user){
 alert("Login required");
 location.href="login.html";
}

/* SAVE USER */
db.collection("users").doc(user.mobile).set({
 name:user.name,
 mobile:user.mobile,
 shop:user.shop,
 address:user.address,
 updatedAt: firebase.firestore.FieldValue.serverTimestamp()
},{merge:true});

/* USER BOX */
userBox.innerHTML=`
<b>${user.name}</b><br>
${user.shop}<br>
üìû ${user.mobile}<br>
üìç ${user.address}
`;

/* CART */
let cart=JSON.parse(localStorage.getItem("cart")||"[]");
let totalAmount=0;
items.innerHTML="";
cart.forEach(p=>{
 totalAmount+=p.price*p.qty;
 items.innerHTML+=`
 <div class="item">
  <span>${p.name} √ó ${p.qty}</span>
  <span>‚Çπ${p.price*p.qty}</span>
 </div>`;
});
document.getElementById("total").innerText=totalAmount;

/* ‚úÖ LAST ORDER (SAFE FIX) */
let lastOrder = JSON.parse(localStorage.getItem("lastOrder"));

/* PLACE ORDER */
async function placeOrder(){
 if(cart.length==0) return alert("Cart empty");

 let order={
  user:user,
  products:cart,
  total:totalAmount,
  note:note.value,
  status:"Pending",
  time: firebase.firestore.FieldValue.serverTimestamp()
 };

 let ref=await db.collection("orders").add(order);
 lastOrder={...order,id:ref.id};
 localStorage.setItem("lastOrder",JSON.stringify(lastOrder));

 sendAdminWhatsApp(lastOrder);
 alert("‚úÖ Order Placed Successfully");
}

/* ADMIN WHATSAPP */
function sendAdminWhatsApp(o){
 let msg=`üßæ NEW ORDER

ID: ${o.id}
Name: ${o.user.name}
Mobile: ${o.user.mobile}
Shop: ${o.user.shop}

TOTAL: ‚Çπ${o.total}
STATUS: Pending`;

 window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=`+encodeURIComponent(msg));
}

/* PDF */
function generateLastPDF(){
 if(!lastOrder) return alert("No order found");

 let o=lastOrder;
 let w=window.open("","_blank");
 w.document.write(`
 <h2>Invoice</h2>
 Order ID: ${o.id}<br>
 Name: ${o.user.name}<br>
 Mobile: ${o.user.mobile}<br>
 Shop: ${o.user.shop}<br>
 Address: ${o.user.address}<hr>
 ${o.products.map(p=>`${p.name} √ó ${p.qty} = ‚Çπ${p.price*p.qty}`).join("<br>")}
 <hr>Total: ‚Çπ${o.total}
 `);
 w.document.close();
 w.print();
}

/* LIVE STATUS */
db.collection("orders")
.where("user.mobile","==",user.mobile)
.orderBy("time","desc")
.onSnapshot(snap=>{
 history.innerHTML="";
 snap.forEach(doc=>{
  let o=doc.data();
  history.innerHTML+=`
  <div>
   <b>Invoice:</b> ${o.invoice||"Pending"}<br>
   ‚Çπ${o.total}
   <span class="badge ${o.status.toLowerCase()}">${o.status}</span><br>
   ${o.tracking?`Tracking: ${o.tracking}`:""}
   <hr>
  </div>`;
 });
});
</script>

</body>
</html>
