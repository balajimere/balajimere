<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#03A64A;color:#fff;padding:14px;text-align:center;font-size:20px}
.box{padding:10px;margin-bottom:190px}
.card{background:#fff;border-radius:8px;padding:10px;margin-bottom:10px}
.item{display:flex;justify-content:space-between;font-size:14px}
.total{text-align:right;font-size:18px;font-weight:bold}
textarea{width:100%;padding:8px}
.fixed{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:1px solid #ccc;padding:10px}
button{width:100%;padding:12px;border:none;border-radius:6px;font-size:16px;margin-bottom:6px}
.wa{background:#25D366;color:#fff}
.pdf{background:#333;color:#fff}
.badge{padding:3px 8px;border-radius:4px;color:#fff;font-size:12px}
.pending{background:orange}
.done{background:green}
.rejected{background:red}
</style>
</head>

<body>

<header>Confirm Order</header>

<div class="box">

<div class="card" id="userBox"></div>

<div class="card">
<h3>üõí Cart</h3>
<div id="cartItems"></div>
<div class="total">‚Çπ <span id="total">0</span></div>
</div>

<div class="card">
<h3>üìù Note</h3>
<textarea id="note"></textarea>
</div>

<div class="card">
<h3>üì¶ My Orders</h3>
<div id="orders"></div>
</div>

</div>

<div class="fixed">
<button class="wa" onclick="placeOrder()">Order on WhatsApp</button>
<button class="pdf" onclick="downloadPDF()">Download Invoice</button>
</div>

<script>
/* üî• Firebase */
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});
const db=firebase.firestore();
const ADMIN="918959216904";

/* üë§ User */
let user=JSON.parse(localStorage.getItem("user"));
if(!user){ alert("Login required"); location.href="login.html"; }

/* Show user */
document.getElementById("userBox").innerHTML=`
<b>${user.name}</b><br>
${user.shop}<br>
üìû ${user.mobile}<br>
üìç ${user.address}
`;

/* üõí Cart */
let cart=JSON.parse(localStorage.getItem("cart")||"[]");
let total=0;
const cartBox=document.getElementById("cartItems");

cartBox.innerHTML="";
cart.forEach(p=>{
 total+=p.price*p.qty;
 cartBox.innerHTML+=`
 <div class="item">
  <span>${p.name} √ó ${p.qty}</span>
  <span>‚Çπ${p.price*p.qty}</span>
 </div>`;
});
document.getElementById("total").innerText=total;

/* üì¶ Place Order */
async function placeOrder(){
 if(cart.length==0) return alert("Cart empty");

 let order={
  user:user,
  products:cart,
  total:total,
  note:document.getElementById("note").value,
  status:"Pending",
  created:Date.now()
 };

 let ref=await db.collection("orders").add(order);
 order.id=ref.id;
 localStorage.setItem("lastOrder",JSON.stringify(order));

 let msg=`üßæ NEW ORDER
ID: ${order.id}
Name: ${user.name}
Mobile: ${user.mobile}
Total: ‚Çπ${order.total}`;

 window.open("https://wa.me/"+ADMIN+"?text="+encodeURIComponent(msg));
 alert("Order Placed");
}

/* üìÑ PDF */
function downloadPDF(){
 let o=JSON.parse(localStorage.getItem("lastOrder"));
 if(!o) return alert("No order");

 let w=window.open("");
 w.document.write(`
 <h2>Invoice</h2>
 Order ID: ${o.id}<br><br>
 ${o.products.map(p=>`${p.name} √ó ${p.qty} = ‚Çπ${p.price*p.qty}`).join("<br>")}
 <hr>Total: ‚Çπ${o.total}
 `);
 w.print();
}

/* üî¥ LIVE Orders */
db.collection("orders")
.where("user.mobile","==",user.mobile)
.onSnapshot(snap=>{
 let html="";
 snap.forEach(d=>{
  let o=d.data();
  html+=`
  <div class="card">
   ‚Çπ${o.total}
   <span class="badge ${o.status.toLowerCase()}">${o.status}</span>
  </div>`;
 });
 document.getElementById("orders").innerHTML=html;
});
</script>

</body>
</html>
