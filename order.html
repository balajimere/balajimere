<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#03A64A;color:#fff;padding:14px;text-align:center;font-size:20px}
.box{padding:10px;margin-bottom:190px}
.card{background:#fff;border-radius:8px;padding:10px;margin-bottom:10px}
.item{display:flex;justify-content:space-between;font-size:14px}
.total{text-align:right;font-size:18px;font-weight:bold}
textarea{width:100%;padding:8px}
.fixed{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:1px solid #ccc;padding:10px}
button{width:100%;padding:12px;border:none;border-radius:6px;font-size:16px;margin-bottom:6px}
.wa{background:#25D366;color:#fff}
.pdf{background:#333;color:#fff}
.badge{padding:3px 8px;border-radius:4px;color:#fff;font-size:12px}
.pending{background:orange}
.done{background:green}
.dispatch{background:#f39c12}
.delivered{background:#2980b9}

/* STATUS LINE */
.track{display:flex;align-items:center;margin-top:8px}
.dot{width:10px;height:10px;border-radius:50%;background:#ccc}
.line{flex:1;height:2px;background:#ccc}
.active{background:#03A64A}
.small{font-size:13px;color:#555}

/* ONLY SCROLL */
#orders{max-height:300px;overflow-y:auto}
</style>
</head>

<body>

<header>Confirm Order</header>

<div class="box">

<div class="card" id="userBox"></div>

<div class="card">
<h3>üõí Cart</h3>
<div id="cartItems"></div>
<div class="total">‚Çπ <span id="total">0</span></div>
</div>

<div class="card">
<h3>üìù Note</h3>
<textarea id="note"></textarea>
</div>

<div class="card">
<h3>üì¶ My Orders</h3>
<div id="orders"></div>
</div>

</div>

<div class="fixed">
<button class="wa" onclick="placeOrder()">Order on WhatsApp</button>
<button class="pdf" onclick="downloadPDF()">Download Invoice</button>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain:"balajimere-c8eb9.firebaseapp.com",
 projectId:"balajimere-c8eb9"
});
const db=firebase.firestore();
const ADMIN="918959216904";

/* USER */
let user=JSON.parse(localStorage.getItem("user"));
if(!user){ alert("Login required"); location.href="login.html"; }

userBox.innerHTML=`
<b>${user.name}</b><br>
${user.shop}<br>
üìû ${user.mobile}<br>
üìç ${user.address}
`;

/* CART */
let cart=JSON.parse(localStorage.getItem("cart")||"[]");
let total=0;
cartItems.innerHTML="";
cart.forEach(p=>{
 total+=p.price*p.qty;
 cartItems.innerHTML+=`
 <div class="item">
  <span>${p.name} √ó ${p.qty}</span>
  <span>‚Çπ${p.price*p.qty}</span>
 </div>`;
});
document.getElementById("total").innerText=total;

/* PLACE ORDER */
async function placeOrder(){
 if(cart.length==0) return alert("Cart empty");

 let order={
  user:user,
  products:cart,
  total:total,
  note:note.value,
  status:"Pending",
  created:Date.now(),
  time: firebase.firestore.FieldValue.serverTimestamp()
 };

 let ref=await db.collection("orders").add(order);
 order.id=ref.id;
 localStorage.setItem("lastOrder",JSON.stringify(order));

 localStorage.removeItem("cart");   // CART CLEAR

 window.open("https://wa.me/"+ADMIN+"?text="+encodeURIComponent(
  `üßæ NEW ORDER\nID: ${order.id}\nName: ${user.name}\nTotal: ‚Çπ${order.total}`
 ));
 alert("Order Placed");
 location.reload();
}

/* PDF */
function downloadPDF(){
 let o=JSON.parse(localStorage.getItem("lastOrder"));
 if(!o) return alert("No order");
 let w=window.open("");
 w.document.write(`
 <h2>Invoice</h2>
 Order ID: ${o.id}<br><br>
 ${o.products.map(p=>`${p.name} √ó ${p.qty} = ‚Çπ${p.price*p.qty}`).join("<br>")}
 <hr>Total: ‚Çπ${o.total}
 `);
 w.print();
}

/* LIVE ORDERS ‚Äì NEWEST ON TOP */
db.collection("orders")
.where("user.mobile","==",user.mobile)
.orderBy("created","desc")
.onSnapshot(snap=>{
 let html="";
 snap.forEach(d=>{
  let o=d.data();
  let s=o.status;
  let d1=s!="Pending";
  let d2=s=="Dispatch"||s=="Delivered";
  let d3=s=="Delivered";

  html+=`
  <div class="card">
   <b>‚Çπ${o.total}</b>
   <span class="badge ${s.toLowerCase()}">${s}</span>

   <div class="track">
    <div class="dot active"></div>
    <div class="line ${d1?'active':''}"></div>
    <div class="dot ${d1?'active':''}"></div>
    <div class="line ${d2?'active':''}"></div>
    <div class="dot ${d2?'active':''}"></div>
    <div class="line ${d3?'active':''}"></div>
    <div class="dot ${d3?'active':''}"></div>
   </div>

   <div class="small">
    Courier: ${o.courierName||"-"}<br>
    Phone: ${o.courierPhone||"-"}<br>
    Tracking: ${o.tracking||"-"}
   </div>
  </div>`;
 });
 orders.innerHTML=html;
});
</script>

</body>
</html>
