<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Marketing Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#03A64A;color:#fff;padding:12px;text-align:center;font-size:18px}
.card{background:#fff;margin:10px;padding:12px;border-radius:10px}
textarea,input,select,button{width:100%;padding:8px;margin-top:6px}
.user{border-bottom:1px solid #ddd;padding:6px}
.small{font-size:12px;color:#666}
</style>
</head>
<body>

<header>ðŸ“¢ Bulk WhatsApp Marketing</header>

<div class="card">
<select id="template">
<option value="">-- Select Template --</option>
<option>ðŸ”¥ New Offer Available!</option>
<option>ðŸ›’ Today Discount on Engine Oil</option>
<option>ðŸšš Order Dispatch Update</option>
</select>

<textarea id="msg" placeholder="Enter message"></textarea>

<input type="file" id="photos" multiple>

<select id="appType">
<option value="wa">WhatsApp</option>
<option value="wa-biz">WhatsApp Business</option>
</select>

<input type="datetime-local" id="schedule">

<button onclick="sendBulk()">Send Message</button>
</div>

<div class="card">
<label><input type="checkbox" id="onlyActive"> Only Active Users</label>
</div>

<div class="card">
<h4>ðŸ“‚ Import CSV (mobile column required)</h4>
<input type="file" id="csv" accept=".csv">
</div>

<div class="card">
<h4>ðŸ“‹ Manual Numbers</h4>
<textarea id="manual" placeholder="Enter numbers comma separated"></textarea>
</div>

<div class="card">
<h4>ðŸ‘¥ Users</h4>
<div id="users"></div>
</div>

<div class="card">
<h4>ðŸ•˜ Message History</h4>
<div id="history"></div>
</div>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain: "balajimere-c8eb9.firebaseapp.com",
 projectId: "balajimere-c8eb9"
});

const db=firebase.firestore();
const IMGBB="5e77bfe737324a6c147697a13fefcb3d";
let USERNUMBERS=[];

/* Load users */
db.collection("users").onSnapshot(s=>{
 users.innerHTML="";
 USERNUMBERS=[];
 s.forEach(d=>{
  let u=d.data();
  if(onlyActive.checked && !u.active) return;
  USERNUMBERS.push(u.mobile);
  users.innerHTML+=`<div class="user">${u.name||"User"} - ${u.mobile}</div>`;
 });
});

/* Template */
template.onchange=()=>msg.value=template.value;

/* CSV Import */
csv.onchange=e=>{
 let file=e.target.files[0];
 let r=new FileReader();
 r.onload=()=>{
  let lines=r.result.split("\n");
  lines.forEach(l=>{
   let n=l.split(",")[0];
   if(n) USERNUMBERS.push(n.trim());
  });
 };
 r.readAsText(file);
}

/* Upload images */
async function uploadImages(){
 let urls=[];
 for(let f of photos.files){
  let fd=new FormData();
  fd.append("image",f);
  let r=await fetch("https://api.imgbb.com/1/upload?key="+IMGBB,{method:"POST",body:fd});
  let j=await r.json();
  urls.push(j.data.url);
 }
 return urls;
}

/* Send */
async function sendBulk(){
 let text=msg.value;
 let nums=[...USERNUMBERS];

 if(manual.value){
  manual.value.split(",").forEach(n=>nums.push(n.trim()));
 }

 if(nums.length==0) return alert("No users");

 let imgUrls=await uploadImages();
 let fullMsg=text+"\n"+imgUrls.join("\n");

 let when=schedule.value?new Date(schedule.value).getTime()-Date.now():0;

 setTimeout(()=>{
  nums.forEach((n,i)=>{
   let link=(appType.value=="wa-biz"?"https://wa.me/":"https://wa.me/");
   window.open(link+"91"+n+"?text="+encodeURIComponent(fullMsg));
  });
  saveHistory(text,nums.length);
 },when);
}

/* History */
function saveHistory(msg,count){
 let h=JSON.parse(localStorage.getItem("history")||"[]");
 h.unshift({msg,count,time:new Date().toLocaleString()});
 localStorage.setItem("history",JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 let h=JSON.parse(localStorage.getItem("history")||"[]");
 history.innerHTML="";
 h.forEach(x=>{
  history.innerHTML+=`<div class="small">${x.time} â†’ ${x.msg} (${x.count})</div>`;
 });
}
renderHistory();
</script>

</body>
</html>
