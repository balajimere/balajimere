<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Marketing Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#03A64A;color:#fff;padding:12px;text-align:center;font-size:18px}
.card{background:#fff;margin:10px;padding:12px;border-radius:10px}
textarea,input,select,button{width:100%;padding:8px;margin-top:6px}
.user{border-bottom:1px solid #ddd;padding:6px;display:flex;align-items:center;gap:6px}
.small{font-size:12px;color:#666}
</style>
</head>
<body>

<header>ðŸ“¢ Bulk WhatsApp Marketing</header>

<div class="card">
<select id="template">
<option value="">-- Select Template --</option>
<option>ðŸ”¥ New Offer Available!</option>
<option>ðŸ›’ Today Discount on Engine Oil</option>
<option>ðŸšš Order Dispatch Update</option>
</select>

<textarea id="msg" placeholder="Enter message"></textarea>

<input type="file" id="photos" multiple>

<select id="appType">
<option value="wa">WhatsApp</option>
<option value="wa-biz">WhatsApp Business</option>
</select>

<input type="datetime-local" id="schedule">

<button onclick="sendNow()">Send Now (Direct)</button>
<button onclick="autoSend()">Auto Send (One by One)</button>
</div>

<div class="card">
<label><input type="checkbox" id="onlyActive"> Only Active Users</label>
</div>

<div class="card">
<h4>ðŸ“‚ Import CSV (name,number)</h4>
<input type="file" id="csv" accept=".csv">
</div>

<div class="card">
<h4>ðŸ‘¥ Users</h4>
<div id="users"></div>
</div>

<div class="card">
<h4>ðŸ•˜ Message History</h4>
<div id="history"></div>
</div>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyCt99elKr4T1OJihGpQ6t2luYmCmEBJeo0",
 authDomain: "balajimere-c8eb9.firebaseapp.com",
 projectId: "balajimere-c8eb9"
});

const db=firebase.firestore();
const IMGBB="5e77bfe737324a6c147697a13fefcb3d";
let USERLIST=[];

/* Load Firebase users */
db.collection("users").onSnapshot(s=>{
 renderUsers([]);
 s.forEach(d=>{
  let u=d.data();
  if(onlyActive.checked && !u.active) return;
  USERLIST.push({name:u.name||"User",mobile:u.mobile});
 });
 renderUsers(USERLIST);
});

/* Render users */
function renderUsers(list){
 users.innerHTML="";
 list.forEach((u,i)=>{
  users.innerHTML+=`
   <div class="user">
    <input type="checkbox" class="ucheck" value="${u.mobile}">
    <div>
      <b>${u.name}</b><br>
      <span class="small">${u.mobile}</span>
    </div>
   </div>`;
 });
}

/* Template */
template.onchange=()=>msg.value=template.value;

/* CSV Import */
csv.onchange=e=>{
 let file=e.target.files[0];
 let r=new FileReader();
 r.onload=()=>{
  let lines=r.result.split("\n");
  let csvUsers=[];
  lines.forEach(l=>{
   let p=l.split(",");
   if(p[1]){
    csvUsers.push({name:p[0],mobile:p[1].trim()});
   }
  });
  USERLIST=USERLIST.concat(csvUsers);
  renderUsers(USERLIST);
 };
 r.readAsText(file);
}

/* Upload images */
async function uploadImages(){
 let urls=[];
 for(let f of photos.files){
  let fd=new FormData();
  fd.append("image",f);
  let r=await fetch("https://api.imgbb.com/1/upload?key="+IMGBB,{method:"POST",body:fd});
  let j=await r.json();
  urls.push(j.data.url);
 }
 return urls;
}

/* Selected numbers */
function getSelected(){
 return [...document.querySelectorAll(".ucheck:checked")].map(c=>c.value);
}

/* Send Now */
async function sendNow(){
 let nums=getSelected();
 if(nums.length==0) return alert("Select users");

 let text=msg.value;
 let imgUrls=await uploadImages();
 let fullMsg=text+"\n"+imgUrls.join("\n");

 nums.forEach(n=>{
  window.open("https://wa.me/91"+n+"?text="+encodeURIComponent(fullMsg));
 });

 saveHistory(text,nums.length);
}

/* Auto Send */
async function autoSend(){
 let nums=getSelected();
 if(nums.length==0) return alert("Select users");

 let text=msg.value;
 let imgUrls=await uploadImages();
 let fullMsg=text+"\n"+imgUrls.join("\n");

 let when=schedule.value?new Date(schedule.value).getTime()-Date.now():0;

 setTimeout(()=>{
  let i=0;
  function next(){
   if(i>=nums.length) return;
   window.open("https://wa.me/91"+nums[i]+"?text="+encodeURIComponent(fullMsg));
   i++;
   setTimeout(next,2000);
  }
  next();
  saveHistory(text,nums.length);
 },when);
}

/* History */
function saveHistory(msg,count){
 let h=JSON.parse(localStorage.getItem("history")||"[]");
 h.unshift({msg,count,time:new Date().toLocaleString()});
 localStorage.setItem("history",JSON.stringify(h));
 renderHistory();
}

function renderHistory(){
 let h=JSON.parse(localStorage.getItem("history")||"[]");
 history.innerHTML="";
 h.forEach(x=>{
  history.innerHTML+=`<div class="small">${x.time} â†’ ${x.msg} (${x.count})</div>`;
 });
}
renderHistory();
</script>

</body>
 </html>
